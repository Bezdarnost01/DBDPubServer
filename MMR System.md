# Полное описание MMR-системы 

## 1. Общие параметры системы

- **Диапазон MMR:** от **0** до **3000**.  
- **Стартовый MMR:** **0** (новый игрок начинает «с чистого листа»).  
- **K-фактор командного матча:**  
  `K_team = 32 × 4 = 128`  
- **Делитель в формуле Elo:** `400`.

## 2. Формулы Elo-прогноза

1. **Средний MMR выживших**:  
   ```math
   \overline{MMR}_{\rm surv} = \frac{MMR_1 + MMR_2 + MMR_3 + MMR_4}{4}
   ```
2. **Ожидаемая вероятность победы выживших**:  
   ```math
   E_{\rm surv} = \frac{1}{1 + 10^{\frac{MMR_{\rm killer} - \overline{MMR}_{\rm surv}}{400}}}
   ```
3. **Ожидаемая вероятность победы убийцы**:  
   ```math
   E_{\rm killer} = 1 - E_{\rm surv}
   ```

## 3. Определение результата R по эмблемам

1. Считаем число выживших с эмблемой **Unbroken** качества **Gold+**.  
2. Правила:  
   - **≥ 3** таких выжившихся → победа **выживших** (`R_surv = 1`).  
   - **≤ 1** → победа **убийцы** (`R_surv = 0`).  
   - **Ровно 2** → смотрим эмблему **Devout** у убийцы:  
     - Devout ≥ Gold → `R_surv = 0`  
     - Иначе → `R_surv = 1`  
3. Для убийцы:  
   ```math
   R_{\rm killer} = 1 - R_{\rm surv}
   ```

## 4. Расчёт изменения MMR

1. **Общее изменение команды выживших**:  
   ```math
   \Delta_{\rm team} = K_{\rm team} \times (R_{\rm surv} - E_{\rm surv})
   ```
2. **Изменение убийцы**:  
   ```math
   \Delta_{\rm killer} = -\Delta_{\rm team}
   ```
3. **Распределение Δ_team между выжившими**:  
   Определяем Performance Score для каждого и веса:  
   ```math
   w_i = \frac{Perf_i}{\sum_{j=1}^{4} Perf_j},
   \quad
   \Delta_i = \Delta_{\rm team} \times w_i
   ```
4. **Бонус «одинокому»**:  
   Если выжил только один и его `Perf_i ≥ threshold`, то:
   - Выживший получает бонус `B` (например, `2` или `3`).  
   - Убийца теряет те же `B` баллов.  
5. **Ограничение границ**:  
   ```text
   new_MMR = min(max(old_MMR + Δ, 0), 3000)
   ```

## 5. Подсчёт Performance Score

Каждую из 4 эмблем оцениваем от `1` до `5`:
- Bronze = 1  
- Silver = 2  
- Gold = 3  
- Platinum = 4  
- Iridescent = 5  

**Пример**:  
`Perf = 3 + 4 + 2 + 5 = 14`

## 6. Пример A (команда выжила)

| Шаг | Формула | Вычисление | Результат |
|:---:|:-------:|:----------:|:---------:|
| 1 | Средний MMR выживших | (1200+1300+1400+1500)/4 | 1350 |
| 2 | E_surv | 1/(1+10^((1600−1350)/400)) | ≈0.192 |
| 3 | Δ_team | 128×(1−0.192) | ≈103.46 |
| 4 | Δ_killer | −103.46 | − |
| 5 | ΣPerf | 3+4+5+2 | 14 |
| 6 | w_i | [3/14,4/14,5/14,2/14] | [0.214,0.286,0.357,0.143] |
| 7 | Δ_i | 103.46×w_i | [22.17,29.56,36.95,14.78] |
| 8 | Новые MMR выживших | — | [1222.17,1329.56,1436.95,1514.78] |
| 9 | Новый MMR убийцы | 1600−103.46 | 1496.54 |

## 7. Пример B (один выжил)

| Шаг | Формула | Вычисление | Результат |
|:---:|:-------:|:----------:|:---------:|
| 1 | Средний MMR выживших | (800+1000+1100+1200)/4 | 1025 |
| 2 | E_surv | 1/(1+10^((1500−1025)/400)) | ≈0.061 |
| 3 | Δ_team | 128×(1−0.061) | ≈120.2 |
| 4 | Δ_killer | −120.2 | − |
| 5 | ΣPerf | 2+3+5+4 | 14 |
| 6 | w_i | [0.143,0.214,0.357,0.286] | — |
| 7 | Базовые Δ выживших | — | [17.2,25.7,42.9,34.4] |
| 8 | Только 4-й выжил | — | Δ4 =120.2+3=123.2 |
| 9 | Δ_killer с бонусом | — | −123.2 |
| 10 | Итоговые MMR | — | выживший:1323, убийца:1377 |
